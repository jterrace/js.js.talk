<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1024" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>JavaScript in JavaScript (js.js): Sandboxing Third-Party Scripts</title>
  
  <meta name="description" content="Demo talk slides for js.js" />
  <meta name="author" content="Jeff Terrace" />
  
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/js.js.talk.css" rel="stylesheet" />
  <link href="css/prettify.css" type="text/css" rel="stylesheet" />
</head>

<body class="impress-not-supported">

<div class="fallback-message">
  <p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
  <p>For the best experience please use the latest <b>Chrome</b>, <b>Safari</b> or <b>Firefox</b> browser.</p>
</div>

<div id="impress">

  <div class="step slide" data-x="0">
    <h1>JavaScript in JavaScript (js.js)</h1>
    <h2>Sandboxing Third-Party Scripts</h2>
    <img id="yodawg" src="img/yodawg.jpg"/>
    <div class="authors">
      <p><strong>Jeff Terrace</strong>, Stephen R. Beard, and Naga Praveen Kumar Katta</p>
      <p><em>Princeton University</em></p>
    </div>
  </div>

  <div class="step slide" data-x="1000">
    <h1>Third-party Scripts</h1>
    <div class="fake-web">
      <div class="btn-group">
        <a class="btn" href="#"><i class="icon-arrow-left"></i></a>
        <a class="btn" href="#"><i class="icon-arrow-right"></i></a>
        <a class="btn" href="#"><i class="icon-repeat"></i></a>
        <input type="text" value="http://example.com/"/>
      </div>
      <p>Hello, World!</p>
    </div>
  </div>
  <div class="step slide overlapped" data-x="1000">
    <h1>Third-party Scripts</h1>
    <div class="fake-web">
      <div class="btn-group">
        <a class="btn" href="#"><i class="icon-arrow-left"></i></a>
        <a class="btn" href="#"><i class="icon-arrow-right"></i></a>
        <a class="btn" href="#"><i class="icon-repeat"></i></a>
        <input type="text" value="http://example.com/"/>
      </div>
      <p>Hello, World!</p>
      <img src="img/fblike.png"/>
    </div>
    <div class="third-includes">
      <h3>Scripts Included</h3>
      <ul>
        <li>https://connect.facebook.net/en_US/all.js</li>
      </ul>
    </div>
  </div>
  <div class="step slide overlapped" data-x="1000">
    <h1>Third-party Scripts</h1>
    <div class="fake-web">
      <div class="btn-group">
        <a class="btn" href="#"><i class="icon-arrow-left"></i></a>
        <a class="btn" href="#"><i class="icon-arrow-right"></i></a>
        <a class="btn" href="#"><i class="icon-repeat"></i></a>
        <input type="text" value="http://example.com/"/>
      </div>
      <p>Hello, World!</p>
      <img src="img/fblike.png"/>
      <img src="img/plusone.png"/>
    </div>
    <div class="third-includes">
      <h3>Scripts Included</h3>
      <ul>
        <li>https://connect.facebook.net/en_US/all.js</li>
        <li>https://apis.google.com/js/plusone.js</li>
      </ul>
    </div>
  </div>
  <div class="step slide overlapped" data-x="1000">
    <h1>Third-party Scripts</h1>
    <div class="fake-web">
      <div class="btn-group">
        <a class="btn" href="#"><i class="icon-arrow-left"></i></a>
        <a class="btn" href="#"><i class="icon-arrow-right"></i></a>
        <a class="btn" href="#"><i class="icon-repeat"></i></a>
        <input type="text" value="http://example.com/"/>
      </div>
      <p>Hello, World!</p>
      <img src="img/fblike.png"/>
      <img src="img/plusone.png"/>
      <img src="img/tweet.png"/>
    </div>
    <div class="third-includes">
      <h3>Scripts Included</h3>
      <ul>
        <li>https://connect.facebook.net/en_US/all.js</li>
        <li>https://apis.google.com/js/plusone.js</li>
        <li>https://platform.twitter.com/widgets.js</li>
      </ul>
    </div>
  </div>
  <div class="step slide overlapped" data-x="1000">
    <h1>Third-party Scripts</h1>
    <div class="fake-web">
      <div class="btn-group">
        <a class="btn" href="#"><i class="icon-arrow-left"></i></a>
        <a class="btn" href="#"><i class="icon-arrow-right"></i></a>
        <a class="btn" href="#"><i class="icon-repeat"></i></a>
        <input type="text" value="http://example.com/"/>
      </div>
      <p>Hello, World!</p>
      <img src="img/fblike.png"/>
      <img src="img/plusone.png"/>
      <img src="img/tweet.png"/><br/>
      <img width="200" src="img/jquery_logo.png"/>
    </div>
    <div class="third-includes">
      <h3>Scripts Included</h3>
      <ul>
        <li>https://connect.facebook.net/en_US/all.js</li>
        <li>https://apis.google.com/js/plusone.js</li>
        <li>https://platform.twitter.com/widgets.js</li>
        <li>http://code.jquery.com/jquery-1.7.2.min.js</li>
      </ul>
    </div>
  </div>
  <div class="step slide overlapped" data-x="1000">
    <h1>Third-party Scripts</h1>
    <div class="fake-web">
      <div class="btn-group">
        <a class="btn" href="#"><i class="icon-arrow-left"></i></a>
        <a class="btn" href="#"><i class="icon-arrow-right"></i></a>
        <a class="btn" href="#"><i class="icon-repeat"></i></a>
        <input type="text" value="http://example.com/"/>
      </div>
      <p>Hello, World!</p>
      <img src="img/fblike.png"/>
      <img src="img/plusone.png"/>
      <img src="img/tweet.png"/><br/>
      <img width="200" src="img/jquery_logo.png"/>
    </div>
    <div class="third-includes">
      <h3>Scripts Included</h3>
      <ul>
        <li>https://connect.<strong>facebook.net</strong>/en_US/all.js</li>
        <li>https://apis.<strong>google.com</strong>/js/plusone.js</li>
        <li>https://platform.<strong>twitter.com</strong>/widgets.js</li>
        <li>http://code.<strong>jquery.com</strong>/jquery-1.7.2.min.js</li>
      </ul>
    </div>
    <ul><li>example.com now trusts these domains!</li></ul>
  </div>

  <div class="step slide" data-x="2000">
    <h1>Existing Solutions</h1>
    <ul>
      <li>iframes
        <ul>
          <li>open to DOS, memory exhaustion, page redirection</li>
        </ul>
      </li>
      <li>Static analysis / Runtime checks
        <ul>
          <li>FBJS, Gatekeeper, ADsafety, BrowserShield, WebSandbox, Caja</li>
          <li>Reduced subset of JS, requires porting</li>
        </ul>
      </li>
      <li>WebWorker sandbox (Treehouse)
        <ul>
          <li>requires message-passing</li>
        </ul>
      </li>
      <li>Browser modifications
        <ul>
          <li>BEEP, Conscript, Atlantis</li>
          <li>Requires modifying the browser, not portable</li>
        </ul>
      </li>
    </ul>
  </div>
  
  <div class="step slide" data-x="3000">
    <h1>Goals</h1>
    <ol>
      <li>Fine-grained access control</li>
      <li>Full JavaScript support
        <ul><li>Including <span class="code">eval</span> and <span class="code">with</span>.</li></ul>
      </li>
      <li>Browser Compatibility
        <ul><li>All major browsers without plugins or modifications</li></ul>
      </li>
      <li>Resilient to attacks
        <ul><li>Spin loops, memory exhaustion, page redirection, DOM modifications</li></ul>
      </li>
    </ol>
  </div>
  
  <div class="step slide" data-x="4000">
    <h1>js.js</h1>
    <ul>
      <li>A JavaScript interpreter that runs on JavaScript</li>
      <li>Executes scripts in a secure sandbox</li>
      <li>Allows site-operators fine-grained control over sandbox</li>
      <li>Implemented by compiling SpiderMonkey to JavaScript using Emscripten</li>
    </ul>
  </div>

  <div class="step slide" data-x="5000">
    <h1>Emscripten</h1>
    <ul>
      <li>Emscripten is an LLVM-to-JavaScript compiler.</li>
      <li>C --> Clang --> LLVM</li>
      <li>LLVM --> Emscripten --> JavaScript</li>
      <li>has its own implementation of libc</li>
      <li><strong>not</strong> an emulator</li>
      <li>emscripten.org</li>
    </ul>
  </div>

  <div class="step slide" data-x="6000">
    <h1>Fibonacci C++</h1>
<pre class="prettyprint">
int fibonacci(unsigned int n) {
  if (n==0 || n==1) {
    return n;
  }
  
  unsigned int prev2 = 0, prev1 = 1, fib = 1, i;
  
  for (i=2; i<=n; i++) {
    fib = prev1 + prev2;
    prev2 = prev1;
    prev1 = fib;
  }
  
  return fib;
}
</pre>
  </div>
  
  <div class="step slide" data-x="7000">
    <h1>Fibonacci LLVM</h1>
<pre class="prettyprint">
define i32 @fibonacci(i32 %n) nounwind readnone {
  %1 = icmp ult i32 %n, 2
  br i1 %1, label %.loopexit, label %.lr.ph
 
.lr.ph:
  %i.04 = phi i32 [ %3, %.lr.ph ], [ 2, %0 ]
  %prev2.03 = phi i32 [ %fib.02, %.lr.ph ], [ 0, %0 ]
  %fib.02 = phi i32 [ %2, %.lr.ph ], [ 1, %0 ]
  %2 = add i32 %prev2.03, %fib.02
  %3 = add i32 %i.04, 1
  %4 = icmp ugt i32 %3, %n
  br i1 %4, label %.loopexit, label %.lr.ph
 
.loopexit:
  %.0 = phi i32 [ %n, %0 ], [ %2, %.lr.ph ]
  ret i32 %.0
}
</pre>
  </div>
  
  <div class="step slide" data-x="8000">
    <h1>Fibonacci JavaScript</h1>
<pre class="prettyprint">
Module._fibonacci = (function (a) {
  var b = 2 > a;
  a: do {
    if (b) {
      var d = a
    } else {
      for (var c = 1, e = 0, f = 2;;) {
        var k = e + c,
          f = f + 1;
        if (f > a) {
          d = k;
          break a
        }
        e = c;
        c = k
      }
    }
  } while (0);
  return d
});
</pre>
  </div>

  <div class="step slide" data-x="9000">
    <h1>js.js Example - 1+1</h1>
    <pre class="prettyprint">
var jsObjs = JSJS.Init();

var compiledObj = JSJS.CompileScript(
                     jsObjs.cx, jsObjs.glob, "1 + 1");

var rval = JSJS.ExecuteScript(
                 jsObjs.cx, jsObjs.glob, compiledObj);

var d = JSJS.ValueToNumber(jsObjs.cx, rval);
console.log(d);
</pre>
    <div class="demo-container">
      <button onclick="toggleIframe(this);">Run Demo</button>
      <div class="demo-contents" data-src="1+1.html"></div>
    </div>
  </div>

  <div class="step slide" data-x="10000">
    <h1>js.js Example - communication</h1>
    <pre class="prettyprint">
function nativeAdd(d1, d2) {
  return d1 + d2;
}
var wrappedNativeFunc = JSJS.wrapFunction({
  func: nativeAdd,
  args: [JSJS.Types['double'], JSJS.Types['double']],
  returns: JSJS.Types['double']});

JSJS.DefineFunction(jsObjs.cx, jsObjs.glob,
            "nativeAdd", wrappedNativeFunc, 2, 0);

var rval = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob,
                   "nativeAdd(17, 2.4);");
</pre>
    <div class="demo-container">
      <button onclick="toggleIframe(this);">Run Demo</button>
      <div class="demo-contents" data-src="communication.html"></div>
    </div>
  </div>

  <div class="step slide" data-x="15000">
    <h1>Microbenchmark</h1>
    <table style="margin-top: 50px; width: 600px;" class="table table-striped">
      <tbody>
      <tr>
        <th>Operation</th>
        <th class="align-right">Mean Execution Time (ms)</th>
      </tr>
      <tr>
        <td>libjs.min.js load</td>
        <td class="align-right">84.9</td>
      </tr>
      <tr>
        <td>NewRuntime</td>
        <td class="align-right">25.2</td>
      </tr>
      <tr>
        <td>NewContext</td>
        <td class="align-right">35.8</td>
      </tr>
      <tr>
        <td>GlobalClassInit</td>
        <td class="align-right">15.5</td>
      </tr>
      <tr>
        <td>StandardClassesInit</td>
        <td class="align-right">60.1</td>
      </tr>
      <tr>
        <td>Execute 1+1</td>
        <td class="align-right">70.6</td>
      </tr>
      <tr>
        <td>DestroyContext</td>
        <td class="align-right">33.3</td>
      </tr>
      <tr>
        <td>DestroyRuntime</td>
        <td class="align-right">1.8</td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="step slide" data-x="16000">
    <h1>Sunspider Benchmark</h1>
    <img class="solo-image" src="img/combined_times.png" />
  </div>

</div>

<script src="js/impress.js"></script>
<script>impress().init();</script>
<script type="text/javascript" src="js/prettify.js"></script>
<script>prettyPrint();</script>
<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="js/js.js.talk.js"></script>

</body>
</html>
